<style>

.header {
	display: flex;
	border-bottom: 1px solid var(--x-smoke);
	align-items: center;
	justify-content: space-between;
	padding: 0 .5em;
	min-height: calc(var(--x-grid-header-height) + 1px);
}

body[theme=dark] .sign-in-logo {
	filter: invert(1);
}

body[theme=dark] .header {
	background-color: #111;
}

textarea.x-editbox-input[console] {
	opacity: 1;
}

#mm_config_form.maxcols1 {
	max-width: 400px;
	grid-template-areas:
		"h1"
		"mm_pubkey"
		"ssh_key_gen_button"
		"ssh_key_updates_button"
		"h2"
		"mysql_root_pass"
	;
}

#mm_deploys_form.maxcols1 {
	grid-template-areas:
		"deploy      status               status                 machine"
		"app         app                  env                    env    "
		"wanted_app_version    wanted_app_version   wanted_sdk_version    wanted_sdk_version"
		"deployed_app_version  deployed_app_version deployed_sdk_version  deployed_sdk_version"
		"deployed_app_commit   deployed_app_commit  deployed_sdk_commit   deployed_sdk_commit"
		"deployed_at deployed_at          started_at             started_at"
		"repo        repo                 repo                   repo   "
		"secret      secret               mysql_pass             mysql_pass"
		"ctime       ctime                mtime                  mtime  "
	;
}

#mm_deploy_buttons_form.maxcols1 {
	grid-template-areas:
		"restart     restart              start                  stop   "
		"dep         dep                  dep                    dep"
	;
}

.mm-logo {
	max-width: 18px;
	display: inline;
	vertical-align: bottom;
	padding-right: 2px;
}

</style>

<x-if hidden global=signed_in>
<x-split fixed_size=140>
	<div theme=dark vflex>
		<div class=header>
			<div><b><img src=/favicon1.ico class=mm-logo> MANY MACHINES</b></div>
			<x-usr-button></x-usr-button>
		</div>
		<x-listbox id=mm_actions_listbox>
			<div action=deploys>Deployments</div>
			<div action=machines>Machines</div>
			<div action=providers>VPS Hosting</div>
			<div action=git_hosting>Git Hosting</div>
			<div action=config>Configuration</div>
		</x-listbox>
	</div>
	<x-vsplit fixed_side=second fixed_size=360>
		<x-switcher nav_id=mm_actions_listbox>
			<x-split action=git_hosting fixed_size=300>
				<x-grid id=mm_git_hosting_grid rowset_name=git_hosting></x-grid>
				<x-form nav_id=mm_git_hosting_grid id=mm_git_hosting_form>
					<x-split fixed_size=400>
						<x-input col=ssh_hostkey></x-input>
						<x-input col=ssh_key></x-input>
					</x-split>
				</x-form>
			</x-split>
			<x-grid action=providers id=mm_providers_grid rowset_name=providers></x-grid>
			<x-split action=machines fixed_side=second fixed_size=1000>
				<x-tabs>
					<x-grid vertical label="Machines"
						id=mm_machines_grid rowset_name=machines></x-grid>
				</x-tabs>
				<x-tabs>
					<x-ct label="CPU / RAM / Disk">
						<x-nav
							id=mm_machine_procinfo_log_nav
							rowset_name=machine_procinfo_log
							param_nav_id=mm_machines_grid params=machine
						>
						</x-nav>
						<div flex>
							<x-chart
								nav_id=mm_machine_procinfo_log_nav
								shape=area sum_cols="max_cpu_sys max_cpu avg_cpu_sys avg_cpu" group_cols=clock
								min_sum=0 max_sum=100
								min_val=-60 max_val=0
							>
							</x-chart>
							<x-chart
								nav_id=mm_machine_procinfo_log_nav
								shape=area sum_cols="ram_used ram_size" group_cols=clock
								min_sum=0 max_sum=4294967296
								min_val=-60 max_val=0
							>
							</x-chart>
							<x-chart
								nav_id=mm_machine_procinfo_log_nav
								shape=area sum_cols="hdd_used hdd_size" group_cols=clock
								min_sum=0 max_sum=107374182400
								min_val=-60 max_val=0
							>
							</x-chart>
						</div>
					</x-ct>
					<x-grid label="MySQL Stats"
						rowset_name=machine_mysql_stats
						param_nav_id=mm_machines_grid params=machine
					>
					</x-grid>
					<x-vsplit label="Machine Backups" fixed_side=second>
						<x-vsplit fixed_side=second fixed_size=29 resizeable=false>
							<x-grid
								id=mm_machine_backups_grid
								rowset_name=machine_backups
								param_nav_id=mm_machines_grid params=machine
							></x-grid>
							<x-form>
								<x-button icon="fa fa-compact-disc"
									action_name=machine_backup
									nav_id=mm_machines_grid
									text="Backup {{machine}}"
								></x-button>
							</x-form>
						</x-vsplit>
						<x-tabs>
							<x-grid label="Backup Copies"
								id=mm_machine_backup_copies_grid
								rowset_name=machine_backup_copies
								param_nav_id=mm_machine_backups_grid params=mbk
							></x-grid>
						</x-tabs>
					</x-vsplit>
				</x-tabs>
			</x-tabs>
			</x-split>
			<x-split action=deploys fixed_size=400>
				<x-tabs>
					<x-grid label=Deployments id=mm_deploys_grid rowset_name=deploys></x-grid>
				</x-tabs>
				<x-split fixed_size=400>
					<x-vsplit fixed_side=second fixed_size=57 resizeable=false>
						<x-tabs>
							<x-form label="Deploy" id=mm_deploys_form nav_id=mm_deploys_grid grid>
								<x-input col=deploy           ></x-input>
								<x-input col=status           ></x-input>
								<x-input col=machine          ></x-input>
								<x-input col=app              ></x-input>
								<x-input col=wanted_app_version    ></x-input>
								<x-input col=deployed_app_version  ></x-input>
								<x-input col=wanted_sdk_version    ></x-input>
								<x-input col=deployed_sdk_version  ></x-input>
								<x-input col=deployed_app_commit   ></x-input>
								<x-input col=deployed_sdk_commit   ></x-input>
								<x-input col=deployed_at           ></x-input>
								<x-input col=started_at            ></x-input>
								<x-input col=env              ></x-input>
								<x-input col=repo             ></x-input>
								<x-input col=secret           widget.copy></x-input>
								<x-input col=mysql_pass       widget.copy></x-input>
								<x-input col=ctime            ></x-input>
								<x-input col=mtime            ></x-input>
							</x-form>
							<x-grid
								label="Custom Vars"
								param_nav_id=mm_deploys_grid params=deploy
								rowset_name=deploy_vars
							></x-grid>
						</x-tabs>
						<x-form id=mm_deploy_buttons_form grid>
							<x-button
								icon="fa fa-arrow-rotate-left"
								load_spin="fa-spin fa-spin-reverse"
								area=restart
								action_name=deploy_restart
								text="Restart"
							></x-button>

							<x-button
								icon="fa fa-play"
								load_spin="fa-beat-fade"
								area=start
								action_name=deploy_start
								text="Start"
								style="align-self: bootom"
							></x-button>

							<x-button icon="fa fa-power-off" area=stop danger
								action_name=deploy_stop
								text="Stop"
							></x-button>

							<x-button
								icon="fa fa-pizza-slice"
								load_spin="fa-fade"
								area=dep
								action_name=deploy_deploy
								text="Deploy"
							></x-button>
						</x-form>
					</x-vsplit>
					<x-tabs>
						<x-ct label="CPU & RAM">
							<x-nav
								id=mm_deploy_procinfo_log
								rowset_name=deploy_procinfo_log
								param_nav_id=mm_deploys_grid params=deploy
							>
							</x-nav>
							<div flex>
								<x-chart
									nav_id=mm_deploy_procinfo_log
									shape=area sum_cols="cpu_sys cpu" group_cols=clock
									min_sum=0 max_sum=100
									min_val=-60 max_val=0
								>
								</x-chart>
								<x-chart
									nav_id=mm_deploy_procinfo_log
									shape=area sum_cols="rss ram_free..ram_size" group_cols=clock
									min_sum=0 max_sum=2147483648
									min_val=-60 max_val=0
								>
								</x-chart>
							</div>
						</x-ct>
						<x-grid label="Live Objects"
							id=mm_deploy_livelist
							rowset_name=deploy_livelist
							param_nav_id=mm_deploys_grid params=deploy
						>
						</x-grid>
						<x-vsplit fixed_side=second label="Live Log">
							<x-grid
								id=mm_deploy_log_grid
								rowset_name=deploy_log
								param_nav_id=mm_deploys_grid params=deploy
							></x-grid>
							<x-textarea mono nav_id=mm_deploy_log_grid col=message></x-textarea>
						</x-vsplit>
						<x-grid label="MySQL Stats"
							rowset_name=deploy_mysql_stats
							param_nav_id=mm_deploys_grid params=deploy
						>
						</x-grid>
						<x-vsplit label="Backups" fixed_side=second>
							<x-grid
								id=mm_deploy_backups_grid
								rowset_name=deploy_backups
								param_nav_id=mm_deploys_grid params=deploy
							></x-grid>
							<x-vsplit fixed_side=second fixed_size=29 resizeable=false>
								<x-tabs>
									<x-grid label="Backup Copies"
										id=mm_deploy_backup_copies_grid
										rowset_name=deploy_backup_copies
										param_nav_id=mm_deploy_backups_grid params=dbk
									></x-grid>
								</x-tabs>
								<x-form>
									<x-button icon="fa fa-compact-disc"
										action_name=deploy_backup
										nav_id=mm_deploys_grid
										text="Backup {{deploy}}"
									></x-button>
								</x-form>
							</x-vsplit>
						</x-vsplit>
						<x-split label="Ops" style="max-width: 600px">
							<x-listbox id=mm_ops_listbox>
								<div action=remove_deploy>Remove deployment</div>
								<div action=rename_deploy>Rename deployment</div>
							</x-listbox>
							<x-switcher nav_id=mm_ops_listbox>
								<div action=remove_deploy class="x-container x-form" style="padding: 0 0 1em 1em">
									<h2>Remove Deployment</h2>
									<p>
										Remove the deployment from the machine completely.
										The deployment remains in the database so the app can be
										redeployed again on the same machine or on a different one,
										and the app data can be restored from a backup.
										You do have a backup, right?
									</p>
									<x-button icon="fa fa-trash" area=remdep danger
										action_name=deploy_remove
										text="Remove Deployment"
										confirm="Are you sure you want to remove the deployment?"
									></x-button>
								</div>
								<div action=rename_deploy class="x-container x-form" style="padding: 0 0 1em 1em">
									<h2>Rename Deployment</h2>
									<p>
										Renaming a deployment is a complex operation,
										involving renaming
										the Linux user account the deployment is on and also the
										MySQL database which is itself a complex operation.
										None of this is transactional, so if anything breaks
										in the middle, you're left to pick up the pieces.
										Also, you need to stop the app first, and restart it
										after the renaming is done. Oh, and you can't mess with
										the server while the rename is in progress, obviously.
										The good news is, this should only take a few seconds
										since all the tables and files are moved, not copied.
									</p>
									<x-textedit id=deploy_rename_new_name_edit nav_id=mm_deploys_grid col=deploy></x-textedit>
									<x-button area=rendep danger action_name=deploy_rename
										text="Rename Deployment"
										confirm="Are you sure you want to rename the deployment?"
									></x-button>
								</div>
							</x-switcher>
						</x-split>
					</x-tabs>
				</x-split>
			</x-split>
			<div action=config class="x-container" style="justify-content: center">
				<x-nav id=mm_config_nav rowset_name=config></x-nav>
				<x-form nav_id=mm_config_nav id=mm_config_form grid>
					<h2 area=h1>SSH</h2>
					<x-textarea mono rows=12 col=mm_pubkey infomode=under
						info="This is the SSH key used to log in as root on all machines.">
					</x-textarea>
					<x-button danger action_name=ssh_key_gen style="grid-area: ssh_key_gen_button"
						text="Generate new key" icon="fa fa-key">
					</x-button>
					<x-button danger action_name=ssh_key_updates style="grid-area: ssh_key_updates_button"
						text="Upload key to all machines" icon="fa fa-upload">
					</x-button>
					<div area=h2><hr><h2>MySQL</h2></div>
					<x-passedit col=mysql_root_pass copy
						info="Derived from the SSH Key. When updating the SSH key
							the MySQL root password is updated too."></x-passedit>
				</x-form>
			</div>
		</x-switcher>
		<x-tabs>
			<x-split label="Running Tasks" fixed_side=second fixed_size=600>
				<x-grid id=mm_running_tasks_grid rowset_name=running_tasks save_on_input action_band_visible=no></x-grid>
				<x-tabs>
					<x-textarea mono console class=x-stretched label="OUT/ERR" id=mm_task_out_textarea nav_id=mm_running_tasks_grid col=out></x-textarea>
					<x-textarea mono console class=x-stretched label="STDIN" id=mm_task_stdin_textarea nav_id=mm_running_tasks_grid col=stdin></x-textarea>
				</x-tabs>
			</x-split>
			<x-split label="Scheduled Tasks" fixed_side=second fixed_size=600>
				<x-grid id=mm_scheduled_tasks_grid rowset_name=scheduled_tasks></x-grid>
				<x-switcher nav_id=mm_scheduled_tasks_grid>
					<x-vsplit action=backup fixed_size=150>
						<x-tabs>
							<x-grid vertical label="Backup Task Deploy"
								rowset_name=scheduled_tasks_backup
								param_nav_id=mm_scheduled_tasks_grid params=task
							></x-grid>
						</x-tabs>
						<x-tabs>
							<x-grid label="Backup Task Copy-to Machines"
								rowset_name=scheduled_tasks_backup_machines
								param_nav_id=mm_scheduled_tasks_grid params=task
							></x-grid>
						</x-tabs>
					</x-vsplit>
				</x-switcher>
			</x-split>
			<x-split label="Task Run Log" fixed_side=second fixed_size=600>
				<x-grid id=mm_task_runs_grid rowset_name=task_runs></x-grid>
				<x-tabs>
					<x-textarea mono console class=x-stretched label="OUT/ERR" id=mm_task_run_out_textarea nav_id=mm_task_runs_grid col=stdouterr></x-textarea>
					<x-textarea mono console class=x-stretched label="STDIN" id=mm_task_run_stdin_textarea nav_id=mm_task_runs_grid col=stdin></x-textarea>
				</x-tabs>
			</x-split>
		</x-tabs>
	</x-vsplit>
</x-split>
</x-if>
